# Анализ данных инвестиций

## Структура данных с сервера

### Endpoint: `/ads/invest/top` (Лучшие варианты)
### Endpoint: `/ads/invest/top/by-budget?budget={amount}` (Поиск по сумме)

## Формат ответа

Оба endpoint возвращают массив объектов следующей структуры:

```typescript
interface InvestmentOption {
  // Основная информация
  fullAddress: string;           // Полный адрес объекта
  square: number;                // Площадь в м²
  countRoom: string | number;    // Количество комнат
  price: number;                  // Цена объекта
  url: string | null;             // Ссылка на объявление
  
  // Аналитика цен
  differencePercent: number | null;  // Процент разницы с рынком (отрицательный = дешевле)
  
  // Детальная аналитика
  analyticsResponse: {
    address: string;              // Адрес для аналитики
    price: string;                 // Форматированная цена (например, "4.1 млн")
    priceMeter: string;           // Цена за м² (например, "91,758")
    priceMin: string;              // Минимальная цена
    priceMax: string;              // Максимальная цена
    annualPriceChangePercent: number;      // Рост за год в %
    threeMonthPriceChangePercent: number;  // Рост за 3 месяца в %
    
    // Данные для графика
    analytics: Array<{
      date: string;                // Дата в формате ISO (например, "2022-03-01T00:00:00")
      avgPrice: number;            // Средняя цена на эту дату
    }>;
  } | null;
}
```

## Валидация данных

### Проблемы, которые могут возникнуть:

1. **Отсутствие обязательных полей**
   - `fullAddress` может отсутствовать (используется `address` как fallback)
   - `price` может быть `null` или `undefined`
   - `analyticsResponse` может быть `null`

2. **Некорректные типы данных**
   - `square` может быть строкой вместо числа
   - `countRoom` может быть числом или строкой
   - `price` может быть строкой с форматированием

3. **Проблемы с аналитикой**
   - `analytics` может быть не массивом
   - Элементы массива могут иметь некорректную структуру
   - Даты могут быть в неверном формате
   - Цены могут быть `null`, `undefined` или некорректными

4. **Проблемы с процентами**
   - `differencePercent` может быть `null`
   - Проценты могут быть некорректными (например, `Infinity`)

## Реализованная валидация

### Функции валидации (`src/utils/investmentDataValidator.js`):

1. **`validateAndNormalizeInvestmentOption(option)`**
   - Проверяет базовую структуру объекта
   - Нормализует поля (например, `address` → `fullAddress`)
   - Проверяет наличие хотя бы цены или аналитики
   - Возвращает `null` для невалидных объектов

2. **`validateAnalyticsResponse(analyticsResponse)`**
   - Проверяет структуру объекта аналитики
   - Валидирует все поля
   - Проверяет наличие хотя бы одного поля с данными
   - Возвращает `null` если данных нет

3. **`validateAnalyticsArray(analytics)`**
   - Проверяет, что это массив
   - Валидирует каждый элемент
   - Фильтрует некорректные элементы
   - Сортирует по дате
   - Проверяет валидность дат и цен

4. **`validateInvestmentOptionsArray(options)`**
   - Валидирует весь массив опций
   - Логирует предупреждения для невалидных элементов
   - Возвращает только валидные опции

5. **`getInvestmentDataStats(options)`**
   - Вычисляет статистику по данным
   - Считает количество объектов с ценой, аналитикой, графиком
   - Вычисляет среднюю цену и диапазон цен

## Обработка данных в компонентах

### `Investing.jsx`

1. **Загрузка данных**
   - После получения данных с сервера вызывается `validateInvestmentOptionsArray()`
   - В режиме разработки логируется статистика данных
   - Невалидные объекты отфильтровываются

2. **Отображение карточек**
   - Проверка на `null` перед отображением полей
   - Условный рендеринг для опциональных полей
   - Fallback значения для отсутствующих данных

### `InvestmentDetailView.jsx`

1. **Подготовка данных графика**
   - Валидация каждого элемента массива `analytics`
   - Проверка типов и валидности дат
   - Фильтрация некорректных данных
   - Сортировка по дате

2. **Отображение аналитики**
   - Условный рендеринг для всех полей
   - Проверка на `null` перед отображением
   - Форматирование процентов с проверкой знака

## Логирование и отладка

В режиме разработки (`import.meta.env.DEV`) логируется:
- Сырые данные с сервера
- Валидированные данные
- Статистика по данным
- Предупреждения о невалидных объектах

## Рекомендации по улучшению

1. **На стороне сервера:**
   - Стандартизировать формат данных
   - Всегда возвращать `fullAddress` (не `address`)
   - Гарантировать наличие хотя бы базовых полей
   - Валидировать данные перед отправкой

2. **На стороне клиента:**
   - Добавить retry логику для неудачных запросов
   - Кэшировать валидированные данные
   - Показывать пользователю информацию о качестве данных
   - Добавить индикаторы загрузки для больших массивов

3. **Мониторинг:**
   - Отслеживать количество невалидных объектов
   - Логировать ошибки валидации
   - Собирать статистику по качеству данных

## Примеры использования

### Валидация одного объекта:
```javascript
import { validateAndNormalizeInvestmentOption } from '../utils/investmentDataValidator'

const option = { /* данные с сервера */ }
const validated = validateAndNormalizeInvestmentOption(option)
if (validated) {
  // Использовать validated
} else {
  // Обработать ошибку
}
```

### Валидация массива:
```javascript
import { validateInvestmentOptionsArray, getInvestmentDataStats } from '../utils/investmentDataValidator'

const data = await response.json()
const validated = validateInvestmentOptionsArray(Array.isArray(data) ? data : [])
const stats = getInvestmentDataStats(validated)
console.log(`Загружено ${stats.total} объектов, из них ${stats.withChart} с графиками`)
```

