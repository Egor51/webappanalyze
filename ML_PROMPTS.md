# Промпты для ML модели прогнозирования цен на недвижимость

## System Prompt

```
Ты - эксперт по анализу рынка недвижимости и прогнозированию цен. Твоя задача - анализировать исторические данные о ценах на недвижимость и делать точные прогнозы на будущее.

Ты получаешь:
1. Адрес недвижимости
2. Исторические данные о средней цене за последние месяцы (массив объектов с полями: date, avgPrice)

Твоя задача:
- Проанализировать тренд изменения цен
- Учесть сезонность и общие тенденции рынка недвижимости
- Сделать прогноз цены на 3, 6 и 12 месяцев вперед
- Вернуть результат в строго определенном JSON формате

Важно:
- Прогноз должен быть реалистичным и основанным на данных
- Учитывай, что рынок недвижимости может иметь сезонные колебания
- Если тренд показывает рост, прогноз должен это отражать, но с учетом возможного замедления
- Если тренд показывает падение, прогноз должен быть консервативным
- Всегда возвращай числовые значения цен (не строки с "млн" и т.д.)

Формат ответа (строго JSON):
{
  "forecast": {
    "month3": число (цена через 3 месяца),
    "month6": число (цена через 6 месяцев),
    "month12": число (цена через 12 месяцев)
  },
  "reasoning": "краткое объяснение прогноза (1-2 предложения)"
}
```

## User Prompt (шаблон для n8n)

**ВАЖНО для n8n**: Используйте поле `historicalDataString` вместо `historicalData` в промпте, чтобы избежать отображения `[object Object]`.

```
Проанализируй исторические данные о ценах на недвижимость и сделай прогноз.

Адрес: {{$json.address}}

Исторические данные:
{{$json.historicalDataString}}

Верни прогноз в формате JSON с полями month3, month6, month12 (числовые значения цен в рублях).
```

### Альтернативный вариант (если historicalDataString недоступен):

Если нужно использовать `historicalData` напрямую, в n8n используйте функцию `JSON.stringify()`:

```
Проанализируй исторические данные о ценах на недвижимость и сделай прогноз.

Адрес: {{$json.address}}

Исторические данные:
{{JSON.stringify($json.historicalData, null, 2)}}

Верни прогноз в формате JSON с полями month3, month6, month12 (числовые значения цен в рублях).
```

### Формат исторических данных (JSON массив):
```json
[
  {"date": "2023-01-01T00:00:00", "avgPrice": 5000000},
  {"date": "2023-02-01T00:00:00", "avgPrice": 5100000},
  {"date": "2023-03-01T00:00:00", "avgPrice": 5200000}
]
```

## Пример запроса

```json
{
  "address": "Мурманск, ул. Ленина, д. 72",
  "historicalData": [
    {"date": "2023-01-01T00:00:00", "avgPrice": 5000000},
    {"date": "2023-02-01T00:00:00", "avgPrice": 5100000},
    {"date": "2023-03-01T00:00:00", "avgPrice": 5200000},
    {"date": "2023-04-01T00:00:00", "avgPrice": 5150000},
    {"date": "2023-05-01T00:00:00", "avgPrice": 5300000},
    {"date": "2023-06-01T00:00:00", "avgPrice": 5400000}
  ],
  "historicalDataString": "[\n  {\"date\": \"2023-01-01T00:00:00\", \"avgPrice\": 5000000},\n  {\"date\": \"2023-02-01T00:00:00\", \"avgPrice\": 5100000},\n  {\"date\": \"2023-03-01T00:00:00\", \"avgPrice\": 5200000},\n  {\"date\": \"2023-04-01T00:00:00\", \"avgPrice\": 5150000},\n  {\"date\": \"2023-05-01T00:00:00\", \"avgPrice\": 5300000},\n  {\"date\": \"2023-06-01T00:00:00\", \"avgPrice\": 5400000}\n]"
}
```

**Примечание**: Поле `historicalDataString` уже включено в запрос от клиента и готово к использованию в промпте n8n.

## Пример ответа

```json
{
  "forecast": {
    "month3": 5500000,
    "month6": 5600000,
    "month12": 5800000
  },
  "reasoning": "Наблюдается стабильный рост цен на 2-3% в месяц. Прогноз основан на продолжении текущего тренда с учетом возможного замедления роста к концу года."
}
```

## Инструкции для настройки в n8n

### Проблема: [object Object] в промпте

Когда n8n пытается отобразить массив объектов в строку, они отображаются как `[object Object]`. 

### Решение 1: Использовать historicalDataString (рекомендуется)

В запросе от клиента уже есть поле `historicalDataString` - это JSON строка с отформатированными данными. Используйте его в промпте:

**User Prompt в n8n AI Agent:**
```
Проанализируй исторические данные о ценах на недвижимость и сделай прогноз.

Адрес: {{$json.address}}

Исторические данные:
{{$json.historicalDataString}}

Верни прогноз в формате JSON с полями month3, month6, month12 (числовые значения цен в рублях).
```

### Решение 2: Использовать JSON.stringify() в n8n Expression

Если `historicalDataString` недоступен, используйте Expression в n8n:

1. В узле перед AI Agent добавьте **Set** или **Code** узел
2. Создайте новое поле `historicalDataFormatted`:
   ```javascript
   {{ JSON.stringify($json.historicalData, null, 2) }}
   ```
3. В промпте используйте:
   ```
   Исторические данные:
   {{$json.historicalDataFormatted}}
   ```

### Решение 3: Использовать Function узел

Создайте **Function** узел перед AI Agent:

```javascript
const items = $input.all();

return items.map(item => {
  return {
    json: {
      ...item.json,
      historicalDataString: JSON.stringify(item.json.historicalData, null, 2)
    }
  };
});
```

### Структура данных в n8n

После получения запроса от клиента, данные будут в формате:
```json
{
  "address": "Мурманск, ул. Ленина, д. 72",
  "historicalData": [
    {"date": "2023-01-01T00:00:00", "avgPrice": 5000000},
    ...
  ],
  "historicalDataString": "[\n  {\"date\": \"2023-01-01T00:00:00\", \"avgPrice\": 5000000},\n  ...\n]"
}
```

## Важные замечания для реализации вебхука

1. **Валидация входных данных**: Проверяй, что historicalData содержит минимум 3 точки данных
2. **Обработка ошибок**: Если данных недостаточно или они некорректны, возвращай ошибку
3. **Формат дат**: Даты должны быть в ISO формате
4. **Формат цен**: Все цены в рублях, числовые значения (не строки)
5. **Таймаут**: Установи разумный таймаут для запроса к GPT-4o (например, 30 секунд)
6. **Кэширование**: Рассмотри возможность кэширования результатов для одинаковых запросов
7. **Сериализация данных**: Всегда используйте `historicalDataString` или `JSON.stringify()` в промптах для корректного отображения

## Структура вебхука

Вебхук должен:
1. Принимать POST запрос с JSON телом
2. Формировать промпты (system + user)
3. Отправлять запрос к GPT-4o API
4. Парсить ответ и валидировать формат
5. Возвращать результат в формате JSON

Пример структуры вебхука (псевдокод):
```
POST /webhook-test/forecast
Body: {
  "address": "string",
  "historicalData": [
    {"date": "ISO string", "avgPrice": number}
  ]
}

Response: {
  "forecast": {
    "month3": number,
    "month6": number,
    "month12": number
  },
  "reasoning": "string" (опционально)
}
```

